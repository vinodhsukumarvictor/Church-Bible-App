"use strict";(()=>{var e={};e.id=691,e.ids=[691],e.modules={9856:e=>{e.exports=require("@sentry/node")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1309:e=>{e.exports=import("@supabase/supabase-js")},3429:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{config:()=>u,default:()=>d,routeModule:()=>c});var n=t(1802),l=t(7153),s=t(6249),i=t(3398),o=e([i]);i=(o.then?(await o)():o)[0];let d=(0,s.l)(i,"default"),u=(0,s.l)(i,"config"),c=new n.PagesAPIRouteModule({definition:{kind:l.x.PAGES_API,page:"/api/admin/audit",pathname:"/api/admin/audit",bundlePath:"",filename:""},userland:i});a()}catch(e){a(e)}})},8579:(e,r,t)=>{t.d(r,{Z:()=>n});let a=null;try{if(process.env.SENTRY_DSN){let e=t(9856);e.init({dsn:process.env.SENTRY_DSN}),a=e}}catch(e){console.warn("Sentry not initialized",e.message||e)}let n=a},3398:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{default:()=>handler});var n=t(1309),l=t(8579),s=e([n]);n=(s.then?(await s)():s)[0];let i=process.env.SUPABASE_URL,o=process.env.SUPABASE_SERVICE_ROLE_KEY,d=i&&o?(0,n.createClient)(i,o):null;async function handler(e,r){if("GET"!==e.method)return r.status(405).json({error:"Method Not Allowed"});if(!d)return r.status(500).json({error:"Supabase service role not configured"});try{let t=e.headers.authorization||"",a=(t.startsWith("Bearer ")?t.split(" ")[1]:t)||null;if(!a)return r.status(401).json({error:"Missing access token"});let{data:n,error:s}=await d.auth.getUser(a?{access_token:a}:void 0);if(s||!n||!n.user)return r.status(401).json({error:"Invalid token"});let i=n.user;if(l.Z&&i)try{l.Z.setUser({id:i.id,email:i.email||null})}catch(e){console.warn("Sentry setUser failed",e?.message||e)}let{data:o,error:u}=await d.from("profiles").select("role").eq("id",i.id).maybeSingle();if(u)throw u;let c=o?.role||null;if(!c||"admin"!==c&&"super_admin"!==c&&"owner"!==c)return r.status(403).json({error:"Forbidden: admin role required"});let _=Math.min(Number(e.query.limit)||25,200),m=e.query.after||null,f=_+1,h=d.from("admin_audit_log").select("id, changed_by, target_user, old_role, new_role, reason, details, created_at").order("created_at",{ascending:!1});m&&(h=h.lt("created_at",m));let{data:g,error:p}=await h.limit(f);if(p)throw p;let y=!1,w=g||[];w.length>_&&(y=!0,w=w.slice(0,_));let b=new Set;for(let e of w)e.changed_by&&b.add(e.changed_by),e.target_user&&b.add(e.target_user);let S=Array.from(b),v={};if(S.length){let{data:e,error:r}=await d.from("profiles").select("id, full_name, email").in("id",S);if(!r&&e)for(let r of e)v[r.id]=r}let E=w.map(e=>({...e,changed_by_name:v[e.changed_by]?.full_name||null,changed_by_email:v[e.changed_by]?.email||null,target_user_name:v[e.target_user]?.full_name||null,target_user_email:v[e.target_user]?.email||null})),j=w.length?w[w.length-1].created_at:null;return r.status(200).json({data:E,next_cursor:j,has_more:y})}catch(e){if(console.error("audit fetch error",e),l.Z)try{l.Z.captureException(e)}catch(e){console.warn("Sentry capture failed",e?.message||e)}return r.status(500).json({error:"Internal Server Error"})}}a()}catch(e){a(e)}})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[222],()=>__webpack_exec__(3429));module.exports=t})();