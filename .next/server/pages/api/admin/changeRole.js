"use strict";(()=>{var e={};e.id=451,e.ids=[451],e.modules={9856:e=>{e.exports=require("@sentry/node")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1309:e=>{e.exports=import("@supabase/supabase-js")},7796:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{config:()=>u,default:()=>d,routeModule:()=>c});var o=t(1802),s=t(7153),n=t(6249),i=t(9963),l=e([i]);i=(l.then?(await l)():l)[0];let d=(0,n.l)(i,"default"),u=(0,n.l)(i,"config"),c=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/admin/changeRole",pathname:"/api/admin/changeRole",bundlePath:"",filename:""},userland:i});a()}catch(e){a(e)}})},3122:(e,r,t)=>{t.d(r,{h:()=>rateLimit});let a=new Map;function rateLimit(e={}){let{tokens:r=10,refillInterval:t=6e4}=e;return function(e,o){let s=e.headers["x-forwarded-for"]||e.socket.remoteAddress||"global",n=Date.now(),i=a.get(s)||{tokens:r,last:n},l=n-i.last;if(l>0){let e=Math.floor(l/t)*r;i.tokens=Math.min(r,i.tokens+e),i.last=n}return i.tokens>0?(i.tokens=i.tokens-1,a.set(s,i),!0):(o.statusCode=429,o.setHeader("Retry-After",Math.ceil(t/1e3)),o.end(JSON.stringify({error:"Too Many Requests"})),!1)}}},8579:(e,r,t)=>{t.d(r,{Z:()=>o});let a=null;try{if(process.env.SENTRY_DSN){let e=t(9856);e.init({dsn:process.env.SENTRY_DSN}),a=e}}catch(e){console.warn("Sentry not initialized",e.message||e)}let o=a},9963:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{default:()=>handler});var o=t(1309),s=t(3122),n=t(8579),i=e([o]);o=(i.then?(await i)():i)[0];let l=process.env.SUPABASE_URL,d=process.env.SUPABASE_SERVICE_ROLE_KEY,u=l&&d?(0,o.createClient)(l,d):null,c=(0,s.h)({tokens:20,refillInterval:6e4});async function handler(e,r){if(c(e,r)){if("POST"!==e.method)return r.status(405).json({error:"Method Not Allowed"});if(!u)return r.status(500).json({error:"Supabase service role not configured"});try{let t=e.headers.authorization||"",a=(t.startsWith("Bearer ")?t.split(" ")[1]:t)||null;if(!a)return r.status(401).json({error:"Missing access token"});let{data:o,error:s}=await u.auth.getUser(a?{access_token:a}:void 0);if(s||!o||!o.user)return r.status(401).json({error:"Invalid token"});let i=o.user;if(n.Z&&i)try{n.Z.setUser({id:i.id,email:i.email||null})}catch(e){console.warn("Sentry setUser failed",e?.message||e)}let{data:l,error:d}=await u.from("profiles").select("role").eq("id",i.id).maybeSingle();if(d)throw d;let c=l?.role||null;if(!c||"admin"!==c&&"super_admin"!==c&&"owner"!==c)return r.status(403).json({error:"Forbidden: admin role required"});let{targetUserId:f,newRole:p,reason:h}=e.body||{};if(!f||!p)return r.status(400).json({error:"Missing parameters"});let{data:m,error:w}=await u.from("profiles").select("role").eq("id",f).maybeSingle();if(w)throw w;let _=m?.role||null,{error:g}=await u.from("profiles").update({role:p}).eq("id",f);if(g)throw g;let{error:y}=await u.from("admin_audit_log").insert([{changed_by:i.id,target_user:f,old_role:_,new_role:p,reason:h||null}]);return y&&console.warn("Failed to write audit log",y),r.status(200).json({ok:!0})}catch(e){if(console.error("changeRole error",e),n.Z)try{n.Z.captureException(e)}catch(e){console.warn("Sentry capture failed",e?.message||e)}return r.status(500).json({error:"Internal Server Error"})}}}a()}catch(e){a(e)}})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[222],()=>__webpack_exec__(7796));module.exports=t})();