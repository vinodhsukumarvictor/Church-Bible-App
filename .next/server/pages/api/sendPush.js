"use strict";(()=>{var e={};e.id=56,e.ids=[56],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8927:e=>{e.exports=require("web-push")},1309:e=>{e.exports=import("@supabase/supabase-js")},1137:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{config:()=>l,default:()=>d,routeModule:()=>p});var n=s(1802),a=s(7153),i=s(6249),o=s(839),u=e([o]);o=(u.then?(await u)():u)[0];let d=(0,i.l)(o,"default"),l=(0,i.l)(o,"config"),p=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/sendPush",pathname:"/api/sendPush",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},839:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{default:()=>handler});var n=s(8927),a=s.n(n),i=s(1309),o=e([i]);i=(o.then?(await o)():o)[0];let u=process.env.SUPABASE_URL,d=process.env.SUPABASE_SERVICE_ROLE_KEY,l=process.env.VAPID_PUBLIC_KEY,p=process.env.VAPID_PRIVATE_KEY,c=process.env.VAPID_CONTACT_EMAIL||"mailto:admin@example.com";l&&p&&a().setVapidDetails(c,l,p);let h=u&&d?(0,i.createClient)(u,d):null;async function handler(e,t){if("POST"!==e.method)return t.status(405).send("Method Not Allowed");if(!h)return t.status(500).send("Supabase service role not configured");if(!l||!p)return t.status(500).send("VAPID keys not configured");try{let{title:s,body:r,url:n="/",userId:i}=e.body||{};if(!s)return t.status(400).send("Missing title");let o=h.from("push_subscriptions").select("*");i&&(o=o.eq("user_id",i));let{data:u,error:d}=await o;if(d)return console.error("Supabase fetch error",d),t.status(500).send("Failed to fetch subscriptions");let l=JSON.stringify({title:s,body:r,url:n}),p=await Promise.allSettled((u||[]).map(e=>a().sendNotification({endpoint:e.endpoint,keys:{p256dh:e.p256dh,auth:e.auth}},l))),c=p.map((e,t)=>({r:e,sub:u[t]})).filter(e=>"rejected"===e.r.status&&e.r.reason?.statusCode&&[404,410].includes(e.r.reason.statusCode));if(c.length){let e=c.map(e=>e.sub.endpoint);await h.from("push_subscriptions").delete().in("endpoint",e),console.warn("Removed stale subscriptions",e.length)}return t.status(200).json({sent:p.length,failed:c.length})}catch(e){return console.error("sendPush error",e),t.status(500).send("Internal Server Error")}}r()}catch(e){r(e)}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[222],()=>__webpack_exec__(1137));module.exports=s})();